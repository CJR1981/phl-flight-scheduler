<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHL Flight Scheduler</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }

    .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
    }

    .header p {
        font-size: 1.1em;
        opacity: 0.9;
    }

    .content {
        padding: 30px;
    }

    .upload-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 25px;
    }

    .upload-section h2 {
        color: #2a5298;
        margin-bottom: 20px;
        font-size: 1.5em;
    }

    .file-upload-group {
        margin-bottom: 20px;
    }

    .file-upload-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #495057;
    }

    .file-input-wrapper {
        position: relative;
        display: inline-block;
        width: 100%;
    }

    .file-input-wrapper input[type="file"] {
        width: 100%;
        padding: 12px;
        border: 2px dashed #cbd5e0;
        border-radius: 6px;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
    }

    .file-input-wrapper input[type="file"]:hover {
        border-color: #667eea;
        background: #f7fafc;
    }

    .file-status {
        margin-top: 8px;
        font-size: 0.9em;
        color: #28a745;
        font-weight: 500;
    }

    .button-group {
        display: flex;
        gap: 15px;
        margin-top: 25px;
        flex-wrap: wrap;
    }

    button {
        padding: 14px 28px;
        font-size: 1em;
        font-weight: 600;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

    .btn-success:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
    }

    .results-section {
        margin-top: 30px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 20px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }

    .stat-card h3 {
        font-size: 0.9em;
        color: #6c757d;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-card .value {
        font-size: 2em;
        font-weight: bold;
        color: #2a5298;
    }

    .table-container {
        overflow-x: auto;
        margin-top: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    th {
        background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    td {
        padding: 12px 15px;
        border-bottom: 1px solid #e9ecef;
    }

    tr:hover {
        background: #f8f9fa;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 600;
    }

    .status-domestic {
        background: #d1ecf1;
        color: #0c5460;
    }

    .status-international {
        background: #fff3cd;
        color: #856404;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 40px;
    }

    .loading.active {
        display: block;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .alert {
        padding: 15px 20px;
        border-radius: 6px;
        margin-bottom: 20px;
    }

    .alert-info {
        background: #d1ecf1;
        border-left: 4px solid #0c5460;
        color: #0c5460;
    }

    .alert-warning {
        background: #fff3cd;
        border-left: 4px solid #856404;
        color: #856404;
    }

    .alert-success {
        background: #d4edda;
        border-left: 4px solid #155724;
        color: #155724;
    }

    .section-title {
        font-size: 1.3em;
        color: #2a5298;
        margin: 30px 0 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }

    .workload-bar {
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
    }

    .workload-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745 0%, #20c997 50%, #ffc107 80%, #dc3545 100%);
        transition: width 0.3s;
    }

    @media (max-width: 768px) {
        .header h1 {
            font-size: 1.8em;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .button-group {
            flex-direction: column;
        }
        
        button {
            width: 100%;
            justify-content: center;
        }
    }
</style>
```

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è PHL Flight Scheduler</h1>
            <p>Philadelphia International Airport - Catering Operations Scheduler</p>
        </div>

```
    <div class="content">
        <div class="upload-section">
            <h2>üìÅ Upload Schedule Files</h2>
            
            <div class="file-upload-group">
                <label for="ftAgents">Full-Time Agents Schedule (CSV)</label>
                <div class="file-input-wrapper">
                    <input type="file" id="ftAgents" accept=".csv" />
                </div>
                <div class="file-status" id="ftStatus"></div>
            </div>

            <div class="file-upload-group">
                <label for="ptAgents">Part-Time Agents Schedule (CSV)</label>
                <div class="file-input-wrapper">
                    <input type="file" id="ptAgents" accept=".csv" />
                </div>
                <div class="file-status" id="ptStatus"></div>
            </div>

            <div class="file-upload-group">
                <label for="flights">Daily Flight Schedule (CSV)</label>
                <div class="file-input-wrapper">
                    <input type="file" id="flights" accept=".csv" />
                </div>
                <div class="file-status" id="flightStatus"></div>
            </div>

            <div class="button-group">
                <button class="btn-primary" id="generateBtn" disabled>
                    üöÄ Generate Schedule
                </button>
                <button class="btn-success" id="exportBtn" disabled>
                    üìä Export to Excel
                </button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Generating optimized schedule...</p>
        </div>

        <div class="results-section" id="results" style="display: none;">
            <h2 class="section-title">üìä Schedule Summary</h2>
            <div class="stats-grid" id="statsGrid"></div>

            <h2 class="section-title">üë• Team Assignments</h2>
            <div class="table-container">
                <table id="teamTable">
                    <thead>
                        <tr>
                            <th>Team</th>
                            <th>Shift</th>
                            <th>Operations</th>
                            <th>Workload</th>
                            <th>First Flight</th>
                            <th>Last Flight</th>
                        </tr>
                    </thead>
                    <tbody id="teamTableBody"></tbody>
                </table>
            </div>

            <h2 class="section-title">üõ´ Flight Assignments</h2>
            <div class="table-container">
                <table id="flightTable">
                    <thead>
                        <tr>
                            <th>Flight</th>
                            <th>Destination</th>
                            <th>Departure Time</th>
                            <th>Type</th>
                            <th>Assigned Team</th>
                            <th>Gate</th>
                        </tr>
                    </thead>
                    <tbody id="flightTableBody"></tbody>
                </table>
            </div>

            <div id="unassignedSection" style="display: none;">
                <h2 class="section-title">‚ö†Ô∏è Unassigned Flights</h2>
                <div class="alert alert-warning" id="unassignedAlert"></div>
                <div class="table-container">
                    <table id="unassignedTable">
                        <thead>
                            <tr>
                                <th>Flight</th>
                                <th>Origin</th>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody id="unassignedTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Global data storage
    let ftAgentsData = null;
    let ptAgentsData = null;
    let flightsData = null;
    let scheduleResult = null;

    // File upload handlers
    document.getElementById('ftAgents').addEventListener('change', (e) => handleFileUpload(e, 'ft'));
    document.getElementById('ptAgents').addEventListener('change', (e) => handleFileUpload(e, 'pt'));
    document.getElementById('flights').addEventListener('change', (e) => handleFileUpload(e, 'flights'));

    function handleFileUpload(event, type) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const text = e.target.result;
            const data = parseCSV(text);
            
            if (type === 'ft') {
                ftAgentsData = data;
                document.getElementById('ftStatus').textContent = `‚úì Loaded ${data.length} full-time agents`;
            } else if (type === 'pt') {
                ptAgentsData = data;
                document.getElementById('ptStatus').textContent = `‚úì Loaded ${data.length} part-time agents`;
            } else if (type === 'flights') {
                flightsData = data;
                document.getElementById('flightStatus').textContent = `‚úì Loaded ${data.length} flights`;
            }

            checkReadyToGenerate();
        };
        reader.readAsText(file);
    }

    function parseCSV(text) {
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        const data = [];

        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            const row = {};
            headers.forEach((header, index) => {
                row[header] = values[index] ? values[index].trim() : '';
            });
            data.push(row);
        }

        return data;
    }

    function checkReadyToGenerate() {
        const ready = ftAgentsData && ptAgentsData && flightsData;
        document.getElementById('generateBtn').disabled = !ready;
    }

    // Schedule generation
    document.getElementById('generateBtn').addEventListener('click', generateSchedule);

    function generateSchedule() {
        document.getElementById('loading').classList.add('active');
        document.getElementById('results').style.display = 'none';

        // Simulate processing time for better UX
        setTimeout(() => {
            try {
                scheduleResult = createSchedule();
                displayResults(scheduleResult);
                document.getElementById('loading').classList.remove('active');
                document.getElementById('results').style.display = 'block';
                document.getElementById('exportBtn').disabled = false;
            } catch (error) {
                alert('Error generating schedule: ' + error.message);
                document.getElementById('loading').classList.remove('active');
            }
        }, 1000);
    }

    function createSchedule() {
        console.log('=== Starting Schedule Generation ===');
        
        // Get Thursday schedules
        const dayOfWeek = 'Thursday';
        const teams = extractTeams(ftAgentsData, ptAgentsData, dayOfWeek);
        console.log(`Teams extracted: ${teams.length}`);
        
        const flights = processFlights(flightsData);
        console.log(`Flights processed: ${flights.length}`);
        
        if (teams.length === 0) {
            throw new Error('No teams found for Thursday. Check that your agent CSV files have Thursday data.');
        }
        
        if (flights.length === 0) {
            throw new Error('No valid flights found. Check that your flight CSV has departure times.');
        }

        // Phase-based assignment
        const assignments = [];
        const unassigned = [];
        const teamWorkload = {};

        teams.forEach(team => {
            teamWorkload[team.id] = {
                team: team,
                operations: [],
                count: 0
            };
        });

        console.log('Starting phase-based assignment...');

        // **PHASE 0: Overnight teams (TM110, TM111) for early morning departures (05:00-08:00)**
        const overnightTeams = teams.filter(t => t.id === 'TM110' || t.id === 'TM111');
        const earlyMorningFlights = flights.filter(f => 
            f.timeMinutes >= 300 && f.timeMinutes < 480 // 5:00 AM to 8:00 AM
        );
        
        console.log(`Phase 0 - Overnight Teams (TM110, TM111): ${earlyMorningFlights.length} early morning flights`);
        console.log(`Overnight teams available: ${overnightTeams.map(t => t.id).join(', ')}`);
        
        // Assign flights to overnight teams - at least 2 each, up to 4 each
        if (overnightTeams.length > 0) {
            assignFlightsToSpecificTeams(earlyMorningFlights, overnightTeams, assignments, unassigned, teamWorkload, 'overnight_early', 2, 4);
        }

        // Phase 1: Early domestic flights (before 07:00) - using early shift teams
        const earlyDomestic = flights.filter(f => 
            f.type === 'Domestic' && f.timeMinutes < 420 &&
            !assignments.some(a => a.flight === f) // Not already assigned
        );
        console.log(`Phase 1 - Early Domestic: ${earlyDomestic.length} flights`);
        assignFlights(earlyDomestic, teams, assignments, unassigned, teamWorkload, 'early_domestic');

        // Phase 2: Morning international bank (07:00-10:00)
        const morningIntl = flights.filter(f => 
            (f.type === 'International' || f.type === 'Precleared') && 
            f.timeMinutes >= 420 && f.timeMinutes < 600 &&
            !assignments.some(a => a.flight === f)
        );
        console.log(`Phase 2 - Morning International: ${morningIntl.length} flights`);
        assignFlights(morningIntl, teams, assignments, unassigned, teamWorkload, 'morning_intl');

        // Phase 3: Mid-day domestic (07:00-18:00)
        const middayDomestic = flights.filter(f => 
            f.type === 'Domestic' && 
            f.timeMinutes >= 420 && f.timeMinutes < 1080 &&
            !assignments.some(a => a.flight === f)
        );
        console.log(`Phase 3 - Midday Domestic: ${middayDomestic.length} flights`);
        assignFlights(middayDomestic, teams, assignments, unassigned, teamWorkload, 'midday_domestic');

        // Phase 4: Evening international bank (18:00-22:00)
        const eveningIntl = flights.filter(f => 
            (f.type === 'International' || f.type === 'Precleared') && 
            f.timeMinutes >= 1080 && f.timeMinutes < 1320 &&
            !assignments.some(a => a.flight === f)
        );
        console.log(`Phase 4 - Evening International: ${eveningIntl.length} flights`);
        assignFlights(eveningIntl, teams, assignments, unassigned, teamWorkload, 'evening_intl');

        // Phase 5: Late domestic (after 18:00)
        const lateDomestic = flights.filter(f => 
            f.type === 'Domestic' && 
            f.timeMinutes >= 1080 &&
            !assignments.some(a => a.flight === f)
        );
        console.log(`Phase 5 - Late Domestic: ${lateDomestic.length} flights`);
        assignFlights(lateDomestic, teams, assignments, unassigned, teamWorkload, 'late_domestic');

        console.log(`=== Schedule Complete ===`);
        console.log(`Assigned: ${assignments.length}, Unassigned: ${unassigned.length}`);
        
        // Log overnight team workload
        overnightTeams.forEach(team => {
            const workload = teamWorkload[team.id];
            console.log(`${team.id}: ${workload.count} operations`);
        });

        return {
            assignments,
            unassigned,
            teamWorkload: Object.values(teamWorkload),
            stats: calculateStats(assignments, unassigned, teams)
        };
    }

    function extractTeams(ftData, ptData, dayOfWeek) {
        const teams = [];
        
        // Column names for Thursday
        const shiftCol = 'Thursday';
        const deptCol = 'Thurs Department';
        const teamCol = 'Thurs Team';

        console.log('Extracting teams for Thursday');
        console.log('Sample FT agent:', ftData[0]);
        console.log('Sample PT agent:', ptData[0]);

        // Process full-time agents
        ftData.forEach(agent => {
            const shift = agent[shiftCol];
            const dept = agent[deptCol];
            const team = agent[teamCol];

            if (shift && shift !== 'Off' && shift !== '' && dept && dept.includes('TRK') && team) {
                // Parse shift start time (format: "0500-1330" or "1300-2130")
                const startTime = shift.split('-')[0];
                const startMinutes = timeToMinutes(startTime);
                
                teams.push({
                    id: team,
                    department: dept,
                    shift: shift,
                    startMinutes: startMinutes,
                    type: 'FT',
                    name: `${agent['First Name']} ${agent['Last Name']}`
                });
            }
        });

        // Process part-time agents
        ptData.forEach(agent => {
            const shift = agent[shiftCol];
            const dept = agent[deptCol];
            const team = agent[teamCol];

            if (shift && shift !== 'Off' && shift !== '' && dept && dept.includes('TRK') && team) {
                // Parse shift start time (format: "0500-1330" or "1300-2130")
                const startTime = shift.split('-')[0];
                const startMinutes = timeToMinutes(startTime);
                
                teams.push({
                    id: team,
                    department: dept,
                    shift: shift,
                    startMinutes: startMinutes,
                    type: 'PT',
                    name: `${agent['First Name']} ${agent['Last Name']}`
                });
            }
        });

        console.log(`Extracted ${teams.length} teams`);
        if (teams.length > 0) {
            console.log('Sample team:', teams[0]);
            console.log(`Team ${teams[0].id} starts at ${teams[0].startMinutes} minutes (${minutesToTime(teams[0].startMinutes)})`);
        }
        return teams;
    }

    function processFlights(flightData) {
        console.log('Processing flights, total rows:', flightData.length);
        if (flightData.length > 0) {
            console.log('Sample flight data:', flightData[0]);
        }
        
        const processed = flightData
            .filter(f => {
                // Filter based on departure scheduled time
                if (!f.Dep_Scheduled || f.Dep_Scheduled === '') return false;
                if (!f.Dep_Flight || f.Dep_Flight === '') return false;
                return true;
            })
            .map(f => {
                // Parse the time from Dep_Scheduled
                let timeStr = f.Dep_Scheduled;
                
                // Extract time portion if it's a full datetime
                if (timeStr.includes(' ')) {
                    const parts = timeStr.split(' ');
                    // Get the time part (should be index 1)
                    timeStr = parts[parts.length - 1];
                }
                
                const timeMinutes = timeToMinutes(timeStr);
                
                return {
                    flight: f.Dep_Flight,
                    origin: f.Arr_Origin || 'N/A',
                    destination: f.Dep_Dest || 'N/A',
                    time: timeStr,
                    timeMinutes: timeMinutes,
                    type: f.Dep_Type || 'Domestic',
                    gate: f.Dep_Gate || f.Arr_Gate || 'TBD',
                    passengers: parseInt(f.Dep_Total_Customers) || parseInt(f.Arr_Total_Customers) || 0,
                    turnType: f.TurnType,
                    equipment: f.Dep_Equip || f.Arr_Equip,
                    arrivalFlight: f.Arr_Flight || '',
                    arrivalTime: f.Arr_ETA || ''
                };
            })
            .filter(f => f.timeMinutes > 0 && f.timeMinutes < 1440) // Valid times only (0-24 hours)
            .sort((a, b) => a.timeMinutes - b.timeMinutes);
        
        console.log('Processed flights:', processed.length);
        if (processed.length > 0) {
            console.log('First flight:', processed[0]);
            console.log('Last flight:', processed[processed.length - 1]);
        }
        
        return processed;
    }

    function assignFlightsToSpecificTeams(flights, teams, assignments, unassigned, teamWorkload, phase, minPerTeam = 2, maxPerTeam = 6) {
        console.log(`\n--- Assigning ${flights.length} flights to specific teams: ${teams.map(t => t.id).join(', ')} (min: ${minPerTeam}, max: ${maxPerTeam}) ---`);
        
        if (flights.length === 0 || teams.length === 0) {
            console.log('No flights or teams available');
            return;
        }
        
        // Sort flights by time
        const sortedFlights = [...flights].sort((a, b) => a.timeMinutes - b.timeMinutes);
        
        // First pass: ensure each team gets minimum flights
        let teamIndex = 0;
        for (let flight of sortedFlights) {
            // Find a team that hasn't reached minimum yet
            let assignedToMin = false;
            for (let i = 0; i < teams.length; i++) {
                const team = teams[i];
                const workload = teamWorkload[team.id];
                
                if (workload.count < minPerTeam && canAssignFlight(team, flight, workload)) {
                    assignments.push({
                        flight: flight,
                        team: team.id,
                        phase: phase
                    });
                    workload.operations.push(flight);
                    workload.count++;
                    assignedToMin = true;
                    console.log(`‚úì ${flight.flight} (${flight.time}) ‚Üí ${team.id} [min target: ${workload.count}/${minPerTeam}]`);
                    break;
                }
            }
            
            if (assignedToMin) {
                continue; // Move to next flight
            }
            
            // Second pass: distribute remaining flights up to max
            let assigned = false;
            for (let team of teams) {
                const workload = teamWorkload[team.id];
                
                if (workload.count < maxPerTeam && canAssignFlight(team, flight, workload)) {
                    assignments.push({
                        flight: flight,
                        team: team.id,
                        phase: phase
                    });
                    workload.operations.push(flight);
                    workload.count++;
                    assigned = true;
                    console.log(`‚úì ${flight.flight} (${flight.time}) ‚Üí ${team.id} [${workload.count}/${maxPerTeam}]`);
                    break;
                }
            }
            
            if (!assigned) {
                // Flight couldn't be assigned to these specific teams
                // Don't add to unassigned - let it be picked up by later phases
                console.log(`‚óã ${flight.flight} (${flight.time}) - will try in later phases`);
            }
        }
        
        console.log(`Phase complete: ${teams.map(t => `${t.id}=${teamWorkload[t.id].count}`).join(', ')}`);
    }

    function assignFlights(flights, teams, assignments, unassigned, teamWorkload, phase) {
        console.log(`\n--- Assigning ${flights.length} flights in phase: ${phase} ---`);
        
        if (flights.length === 0) {
            console.log('No flights to assign in this phase');
            return;
        }
        
        flights.forEach((flight, index) => {
            let assigned = false;
            let bestTeam = null;
            let minWorkload = Infinity;
            let rejectionReasons = [];

            // Find best available team (with least workload)
            for (let team of teams) {
                const workload = teamWorkload[team.id];
                
                // Check if team can handle this flight
                if (canAssignFlight(team, flight, workload)) {
                    if (workload.count < minWorkload) {
                        minWorkload = workload.count;
                        bestTeam = team;
                    }
                } else {
                    // Track why we couldn't assign
                    const teamReady = team.startMinutes - 15;
                    if (flight.timeMinutes < teamReady) {
                        rejectionReasons.push(`${team.id}: too early (flight ${flight.timeMinutes} < team ready ${teamReady})`);
                    } else if (workload.count >= 8) {
                        rejectionReasons.push(`${team.id}: full (${workload.count} ops)`);
                    }
                }
            }

            if (bestTeam) {
                const workload = teamWorkload[bestTeam.id];
                assignments.push({
                    flight: flight,
                    team: bestTeam.id,
                    phase: phase
                });
                workload.operations.push(flight);
                workload.count++;
                assigned = true;
                
                if (index < 3) { // Log first few assignments
                    console.log(`‚úì ${flight.flight} (${flight.time}) ‚Üí ${bestTeam.id}`);
                }
            } else {
                unassigned.push({
                    flight: flight,
                    reason: 'No available team matching timing and operational constraints'
                });
                
                if (index < 3) { // Log first few failures
                    console.log(`‚úó ${flight.flight} (${flight.time}) - ${rejectionReasons.slice(0, 2).join(', ')}`);
                }
            }
        });
        
        console.log(`Phase complete: ${flights.filter((f, i) => assignments.some(a => a.flight === f)).length} assigned, ${flights.filter((f, i) => unassigned.some(u => u.flight === f)).length} unassigned`);
    }

    function canAssignFlight(team, flight, workload) {
        // Special handling for overnight teams (TM110, TM111)
        // They work 23:00-05:00 (2300-0500), so they're ready for early morning departures
        const isOvernightTeam = team.id === 'TM110' || team.id === 'TM111';
        
        if (isOvernightTeam) {
            // Overnight teams can service flights from 05:00-08:00
            if (flight.timeMinutes < 300 || flight.timeMinutes > 480) {
                return false; // Only 5am-8am flights
            }
            
            // Check workload limit for overnight teams
            if (workload.count >= 4) {
                return false;
            }
            
            // Check timing between operations (30 min minimum)
            if (workload.operations.length > 0) {
                const lastOp = workload.operations[workload.operations.length - 1];
                const timeSinceLastOp = flight.timeMinutes - lastOp.timeMinutes;
                if (timeSinceLastOp < 30) {
                    return false;
                }
            }
            
            return true;
        }
        
        // Regular team logic
        // Check if team has started (allow 15 minutes before shift for early prep)
        const teamReadyTime = team.startMinutes - 15;
        if (flight.timeMinutes < teamReadyTime) {
            return false;
        }
        
        // Check if flight is too late (after shift end + 2 hours overtime potential)
        const shiftEnd = team.startMinutes + (8.5 * 60); // 8.5 hour shift
        const maxTime = shiftEnd + 120; // Allow 2 hours overtime
        if (flight.timeMinutes > maxTime) {
            return false;
        }

        // Check workload limit (max 8 operations to be more flexible)
        if (workload.count >= 8) {
            return false;
        }

        // Check timing conflicts with last operation
        if (workload.operations.length > 0) {
            const lastOp = workload.operations[workload.operations.length - 1];
            const timeSinceLastOp = flight.timeMinutes - lastOp.timeMinutes;
            
            // Must have some gap between operations
            if (timeSinceLastOp < 30) {
                return false;
            }
            
            // International flights need more time
            if (flight.type === 'International' || flight.type === 'Precleared') {
                // Need at least 60 minutes after last domestic operation
                if (lastOp.type === 'Domestic' && timeSinceLastOp < 60) {
                    return false;
                }
                // Need at least 90 minutes after last international operation
                if ((lastOp.type === 'International' || lastOp.type === 'Precleared') && timeSinceLastOp < 90) {
                    return false;
                }
            }
        }

        return true;
    }

    function calculateStats(assignments, unassigned, teams) {
        const domestic = assignments.filter(a => a.flight.type === 'Domestic').length;
        const international = assignments.filter(a => a.flight.type === 'International').length;

        return {
            totalFlights: assignments.length + unassigned.length,
            assigned: assignments.length,
            unassigned: unassigned.length,
            domestic: domestic,
            international: international,
            teamsDeployed: teams.length,
            coveragePercent: Math.round((assignments.length / (assignments.length + unassigned.length)) * 100)
        };
    }

    function timeToMinutes(timeStr) {
        if (!timeStr || timeStr === '') return 0;
        
        // Remove any whitespace
        timeStr = timeStr.trim();
        
        // Handle full datetime format like "1/0/1900 23:55"
        if (timeStr.includes('/')) {
            const parts = timeStr.split(' ');
            if (parts.length > 1) {
                timeStr = parts[1]; // Get the time part
            } else {
                return 0; // Invalid format
            }
        }
        
        // Handle time with AM/PM
        if (timeStr.includes('AM') || timeStr.includes('PM')) {
            const isPM = timeStr.includes('PM');
            timeStr = timeStr.replace(/AM|PM/g, '').trim();
            const parts = timeStr.split(':');
            let hours = parseInt(parts[0]);
            const mins = parseInt(parts[1] || 0);
            
            if (isPM && hours !== 12) hours += 12;
            if (!isPM && hours === 12) hours = 0;
            
            return hours * 60 + mins;
        }
        
        // Handle 24-hour format with colon (HH:MM or H:MM)
        if (timeStr.includes(':')) {
            const parts = timeStr.split(':');
            const hours = parseInt(parts[0]);
            const mins = parseInt(parts[1] || 0);
            
            if (isNaN(hours) || isNaN(mins)) return 0;
            return hours * 60 + mins;
        }
        
        // Handle 4-digit format without colon (HHMM like "0500" or "1330")
        if (timeStr.length === 4 && !isNaN(timeStr)) {
            const hours = parseInt(timeStr.substring(0, 2));
            const mins = parseInt(timeStr.substring(2, 4));
            
            if (isNaN(hours) || isNaN(mins)) return 0;
            return hours * 60 + mins;
        }
        
        // Handle 3-digit format (HMM like "500" for 5:00)
        if (timeStr.length === 3 && !isNaN(timeStr)) {
            const hours = parseInt(timeStr.substring(0, 1));
            const mins = parseInt(timeStr.substring(1, 3));
            
            if (isNaN(hours) || isNaN(mins)) return 0;
            return hours * 60 + mins;
        }
        
        // Handle 1 or 2 digit format (just hours)
        if ((timeStr.length === 1 || timeStr.length === 2) && !isNaN(timeStr)) {
            const hours = parseInt(timeStr);
            if (isNaN(hours)) return 0;
            return hours * 60;
        }
        
        console.warn(`Unable to parse time: "${timeStr}"`);
        return 0;
    }

    function minutesToTime(minutes) {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    }

    // Display results
    function displayResults(result) {
        // Display stats
        const statsGrid = document.getElementById('statsGrid');
        statsGrid.innerHTML = `
            <div class="stat-card">
                <h3>Total Flights</h3>
                <div class="value">${result.stats.totalFlights}</div>
            </div>
            <div class="stat-card">
                <h3>Assigned</h3>
                <div class="value">${result.stats.assigned}</div>
            </div>
            <div class="stat-card">
                <h3>Coverage</h3>
                <div class="value">${result.stats.coveragePercent}%</div>
            </div>
            <div class="stat-card">
                <h3>Domestic</h3>
                <div class="value">${result.stats.domestic}</div>
            </div>
            <div class="stat-card">
                <h3>International</h3>
                <div class="value">${result.stats.international}</div>
            </div>
            <div class="stat-card">
                <h3>Teams Deployed</h3>
                <div class="value">${result.stats.teamsDeployed}</div>
            </div>
        `;

        // Display team workload
        const teamTableBody = document.getElementById('teamTableBody');
        teamTableBody.innerHTML = '';
        result.teamWorkload.forEach(tw => {
            const firstFlight = tw.operations[0];
            const lastFlight = tw.operations[tw.operations.length - 1];
            const row = `
                <tr>
                    <td><strong>${tw.team.id}</strong></td>
                    <td>${tw.team.shift}</td>
                    <td>${tw.count}</td>
                    <td>
                        <div class="workload-bar">
                            <div class="workload-fill" style="width: ${(tw.count / 6) * 100}%"></div>
                        </div>
                    </td>
                    <td>${firstFlight ? firstFlight.time : '-'}</td>
                    <td>${lastFlight ? lastFlight.time : '-'}</td>
                </tr>
            `;
            teamTableBody.innerHTML += row;
        });

        // Display flight assignments
        const flightTableBody = document.getElementById('flightTableBody');
        flightTableBody.innerHTML = '';
        result.assignments.forEach(a => {
            const row = `
                <tr>
                    <td><strong>${a.flight.flight}</strong></td>
                    <td>${a.flight.destination}</td>
                    <td>${a.flight.time}</td>
                    <td><span class="status-badge status-${a.flight.type.toLowerCase()}">${a.flight.type}</span></td>
                    <td>${a.team}</td>
                    <td>${a.flight.gate}</td>
                </tr>
            `;
            flightTableBody.innerHTML += row;
        });

        // Display unassigned flights
        if (result.unassigned.length > 0) {
            document.getElementById('unassignedSection').style.display = 'block';
            document.getElementById('unassignedAlert').textContent = 
                `${result.unassigned.length} flights could not be assigned. Consider adding overtime or split shifts.`;
            
            const unassignedTableBody = document.getElementById('unassignedTableBody');
            unassignedTableBody.innerHTML = '';
            result.unassigned.forEach(u => {
                const row = `
                    <tr>
                        <td><strong>${u.flight.flight}</strong></td>
                        <td>${u.flight.destination}</td>
                        <td>${u.flight.time}</td>
                        <td><span class="status-badge status-${u.flight.type.toLowerCase()}">${u.flight.type}</span></td>
                        <td>${u.reason}</td>
                    </tr>
                `;
                unassignedTableBody.innerHTML += row;
            });
        }
    }

    // Export to Excel
    document.getElementById('exportBtn').addEventListener('click', exportToExcel);

    function exportToExcel() {
        if (!scheduleResult) return;

        const wb = XLSX.utils.book_new();

        // Team Schedule sheet
        const teamData = scheduleResult.teamWorkload.map(tw => ({
            'Team': tw.team.id,
            'Department': tw.team.department,
            'Shift': tw.team.shift,
            'Operations': tw.count,
            'First Flight': tw.operations[0] ? tw.operations[0].time : '',
            'Last Flight': tw.operations[tw.operations.length - 1] ? tw.operations[tw.operations.length - 1].time : ''
        }));
        const teamSheet = XLSX.utils.json_to_sheet(teamData);
        XLSX.utils.book_append_sheet(wb, teamSheet, 'Team Schedule');

        // Flight Assignments sheet
        const flightData = scheduleResult.assignments.map(a => ({
            'Flight': a.flight.flight,
            'Destination': a.flight.destination,
            'Departure Time': a.flight.time,
            'Type': a.flight.type,
            'Team': a.team,
            'Gate': a.flight.gate,
            'Passengers': a.flight.passengers,
            'Arrival Flight': a.flight.arrivalFlight,
            'Arrival Time': a.flight.arrivalTime
        }));
        const flightSheet = XLSX.utils.json_to_sheet(flightData);
        XLSX.utils.book_append_sheet(wb, flightSheet, 'Flight Assignments');

        // Unassigned sheet
        if (scheduleResult.unassigned.length > 0) {
            const unassignedData = scheduleResult.unassigned.map(u => ({
                'Flight': u.flight.flight,
                'Destination': u.flight.destination,
                'Departure Time': u.flight.time,
                'Type': u.flight.type,
                'Reason': u.reason
            }));
            const unassignedSheet = XLSX.utils.json_to_sheet(unassignedData);
            XLSX.utils.book_append_sheet(wb, unassignedSheet, 'Unassigned');
        }

        // Save file
        const date = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `PHL_Schedule_${date}.xlsx`);
    }
</script>
```

</body>
</html>